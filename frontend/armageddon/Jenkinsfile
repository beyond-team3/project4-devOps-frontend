pipeline {
    agent any

    environment {
        DOCKER_CRED = credentials('docker-hub-guntinue')
        IMAGE_NAME = 'guntinue/armageddon-frontend'
    }

    stages {
        // ë…¸ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
        stage('Build Node.js') {
            steps {
                dir('frontend') {
                    // Node.jsê°€ ì  í‚¨ìŠ¤ ì„œë²„ì— ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
                    // ì—†ë‹¤ë©´ docker agentë¥¼ ì“°ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ ì¼ë‹¨ ì‰˜ë¡œ ì§„í–‰
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }

        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage('Docker Build') {
            steps {
                dir('frontend') {
                    // í”Œë«í¼ ëª…ì‹œ (Mac M1/M2 ì‚¬ìš©ìë¥¼ ìœ„í•´ amd64 ê°•ì œ)
                    sh 'docker build --no-cache --platform linux/amd64 -t $IMAGE_NAME:latest .'
                }
            }
        }

        // ë„ì»¤ í—ˆë¸Œ í‘¸ì‹œ
        stage('Docker Push') {
            steps {
                sh 'echo $DOCKER_CRED_PSW | docker login -u $DOCKER_CRED_USR --password-stdin'
                sh 'docker push $IMAGE_NAME:latest'
            }
        }

        // ë°°í¬
        stage('Deploy to K8s') {
            steps {
                // í”„ë¡ íŠ¸ì—”ë“œ íŒŒë“œ ì‚­ì œ -> ì¬ì‹œì‘
                sh 'kubectl delete pod -l app=frontend --ignore-not-found=true'
            }
        }
    }

    post {
        success {
            echo 'ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ! ì‚¬ì´íŠ¸ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.'
        }
        failure {
            echo 'ğŸ’¥ ì—ëŸ¬ ë°œìƒ! ë„ì›€!'
        }
    }
}