pipeline {
    agent any

    environment {
        // GitHub ì €ì¥ì†Œ URL
        SOURCE_GITHUB_URL = 'https://github.com/beyond-team3/project4-devOps-frontend.git'
        MANIFESTS_GITHUB_URL = 'https://github.com/beyond-team3/project4-devOps-manifests.git'

        // Git ì„¤ì •
        GIT_USERNAME = 'guntinue'
        GIT_EMAIL = 'rjssn93@gmail.com'
    }

    stages {
        stage('Source Build') {
            steps {
                // ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                git branch: 'main',
                    credentialsId: 'guntinue-git-auth',
                    url: "${env.SOURCE_GITHUB_URL}"

                // Node.js ë¹Œë“œ
                dir('frontend/armageddon') {
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }

        stage('Docker Build and Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-guntinue', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {

                        // íŒŒì¼ êµ¬ì¡° ë¡œê·¸ë¡œ í™•ì¸
                        sh 'echo "===  í˜„ì¬ íŒŒì¼ êµ¬ì¡° í™•ì¸ ==="'
                        sh 'find . -maxdepth 3 -not -path "*/node_modules/*"'

                        dir('frontend/armageddon') {
                            // Dockerfile ì¡´ì¬ì—¬ë¶€ ë¡œê·¸ë¡œ í™•ì¸
                            sh 'echo "=== ğŸ“ í˜„ì¬ ìœ„ì¹˜ íŒŒì¼ í™•ì¸ ==="'
                            sh 'ls -al'

                            if (isUnix()) {
                                sh "docker build --no-cache -t ${DOCKER_USER}/armageddon-frontend:${currentBuild.number} ."
                                sh "docker build --no-cache -t ${DOCKER_USER}/armageddon-frontend:latest ."
                                sh "docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}"
                                sh "docker push ${DOCKER_USER}/armageddon-frontend:${currentBuild.number}"
                                sh "docker push ${DOCKER_USER}/armageddon-frontend:latest"
                                sh "docker logout"
                            } else {
                                bat "docker build --no-cache -t ${DOCKER_USER}/armageddon-frontend:${currentBuild.number} ."
                                bat "docker build --no-cache -t ${DOCKER_USER}/armageddon-frontend:latest ."
                                bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                                bat "docker push ${DOCKER_USER}/armageddon-frontend:${currentBuild.number}"
                                bat "docker push ${DOCKER_USER}/armageddon-frontend:latest"
                                bat "docker logout"
                            }
                        }
                    }
                }
            }
        }

        stage('k8s Manifest Update') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'DOCKERHUB_PASSWORD', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS'),
                        usernamePassword(credentialsId: 'guntinue-git-auth', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')
                    ]) {
                        dir('frontend') {
                            // Manifest ì €ì¥ì†Œ ê°€ì ¸ì˜¤ê¸°
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: 'main']],
                                userRemoteConfigs: [[
                                    url: "https://github.com/beyond-team3/project4-devOps-manifests.git",
                                    credentialsId: 'guntinue-git-auth'
                                ]],
                                extensions: [[$class: 'CleanBeforeCheckout']],
                                poll: false
                            ])

                            sh 'echo "=== ğŸ“‚ íŒŒì¼ ëª©ë¡ í™•ì¸ ==="'
                            sh 'ls -al'

                            // Git ì‚¬ìš©ì ì„¤ì •
                            sh "git config user.name 'guntinue'"
                            sh "git config user.email 'rjssn93@gmail.com'"

                            sh """
                                # ê°•ì œë¡œ ë¡œì»¬ main ë¸Œëœì¹˜ë¥¼ ì›ê²© mainê³¼ ë§ì¶¤ (ì•ˆí•˜ë©´ Detached HEAD ë°œìƒ..!)
                                git checkout -B main origin/main

                                # ì´ë¯¸ì§€ íƒœê·¸ ìˆ˜ì •
                                sed -i '' 's|image: .*|image: ${DOCKER_USER}/armageddon-frontend:${currentBuild.number}|g' frontend/deployment.yml

                                # ì»¤ë°‹
                                git add frontend/deployment.yml
                                git commit -m 'Update frontend image to ${currentBuild.number} [skip ci]' || echo 'No changes to commit'

                                # ìµœì‹  ë‚´ìš© ë‹¹ê²¨ì˜¤ê¸° (ì¶©ëŒ ë°©ì§€)
                                git pull origin main --rebase

                                # í‘¸ì‹œ
                                git push https://${GIT_USER}:${GIT_TOKEN}@github.com/beyond-team3/project4-devOps-manifests.git main
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                if (isUnix()) {
                    sh 'docker logout || true'
                } else {
                    bat 'docker logout || true'
                }
            }
        }
        success {
            withCredentials([string(credentialsId: 'armageddon-discord', variable: 'DISCORD')]) {
                discordSend(
                    description: """
                    **ë¹Œë“œ ì„±ê³µ!** :tada:

                    **ì œëª©**: ${currentBuild.displayName}
                    **ê²°ê³¼**: :white_check_mark: ${currentBuild.currentResult}
                    **ì‹¤í–‰ ì‹œê°„**: ${currentBuild.duration / 1000}s
                    **ë§í¬**: [ë¹Œë“œ ê²°ê³¼ ë³´ê¸°](${env.BUILD_URL})
                    """,
                    title: "${env.JOB_NAME} ë¹Œë“œ ì„±ê³µ!",
                    webhookURL: "$DISCORD"
                )
            }
        }
        failure {
            withCredentials([string(credentialsId: 'armageddon-discord', variable: 'DISCORD')]) {
                discordSend(
                    description: """
                    **ë¹Œë“œ ì‹¤íŒ¨!** :x:

                    **ì œëª©**: ${currentBuild.displayName}
                    **ê²°ê³¼**: :x: ${currentBuild.currentResult}
                    **ì‹¤í–‰ ì‹œê°„**: ${currentBuild.duration / 1000}s
                    **ë§í¬**: [ë¹Œë“œ ê²°ê³¼ ë³´ê¸°](${env.BUILD_URL})
                    """,
                    title: "${env.JOB_NAME} ë¹Œë“œ ì‹¤íŒ¨!",
                    webhookURL: "$DISCORD"
                )
            }
        }
    }
}
